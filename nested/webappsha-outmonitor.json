{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "hostingPlan": {
            "type": "object"
        },
        "restServer": {
            "type": "object"
        },
        "webApp": {
            "type": "object"
        },
        "iotHub": {
            "type": "object"
        },
        "sqlServer": {
            "type": "object"
        },
        "eventHub": {
            "type": "object"
        },
        "B2CVariables": {
            "type": "object"
        },
        "documentDB": {
            "type": "object"
        },
        "nodeServer": {
            "type": "object"
        },
        "documentDBEndpoint": {
            "type": "string"
        },
        "webJobStorage": {
            "type": "object"
        },
        "trafficManagerSettings": {
            "type": "object"
        }
    },
    "variables": {},
    "resources": [
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('hostingPlan').hostingPlanName]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[parameters('hostingPlan').location]",
            "tags": {
                "displayName": "HostingPlan"
            },
            "sku": {
                "name": "[parameters('hostingPlan').webSkuName]",
                "capacity": "[parameters('hostingPlan').skuCapacity]"
            },
            "properties": {
                "name": "[parameters('hostingPlan').hostingPlanName]"
            }
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('restServer').apiServerName]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('restServer').location]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanName]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName))]": "empty",
                "displayName": "RESTServer"
            },
            "properties": {
                "name": "[parameters('restServer').apiServerName]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName)]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015",
                        "cors": {
                            "allowedOrigins": [
                                "[concat('https://', parameters('trafficManagerSettings').trafficManagerName, '.trafficmanager.net')]"
                            ]
                        }
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('restServer').location]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/config/web')]"
                    ],
                    "tags": {
                        "displayName": "RESTServerMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('restServer').RESTServerPackageURI2]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('restServer').BlobconnectionString]",
                            "type": "Custom"
                        },
                        "DBConnection": {
                            "value": "[parameters('sqlServer').databaseConnString]",
                            "type": "Custom"
                        },
                        "AzureWebJobsDashboard": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageName,';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageName), '2015-06-15').key1)]",
                            "type": "Custom"
                        },
                        "AzureWebJobsStorage": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageName,';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageName), '2015-06-15').key1)]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "restAppSettings"
                    },
                    "properties": {
                        "iotHub:ConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                        "iotHub:HostName": "[parameters('iotHub').iotHubHostName]",
                        "iotHub:SharedAccessPolicyKey": "[listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey]",
                        "iotHub:SharedAccessPolicyName": "[ parameters('iotHub').iotHubKeyName]",
                        "sql:Server": "[concat(parameters('sqlServer').sqlFailoverGroupName,'.database.windows.net')]",
                        "sql:Database": "[parameters('sqlServer').sqldatabasename]",
                        "sql:User": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "sql:Password": "[parameters('sqlServer').sqlAdministratorLoginPassword]",
                        "sa:WindowsManagementUri": "[parameters('restServer').WindowsManagementUri]",
                        "sa:ReportJobName": "[parameters('restServer').ReportJobName]",
                        "sa:JobResourceGroup": "[parameters('restServer').JobResourceGroup]",
                        "sa:JobLocation": "[parameters('restServer').location]",
                        "sa:AlertJobTable": "[parameters('restServer').alertJobTable]",
                        "ad:SubscriptionId": "[parameters('restServer').AdSubscriptionId]",
                        "ad:TenantId": "[parameters('restServer').AdTenantId]",
                        "ad:Endpoint": "[parameters('restServer').ADEndpoint]",
                        "ad:ClientId": "[parameters('restServer').AdClientId]",
                        "ad:ClientSecret": "[parameters('restServer').AdSecretKey]",
                        "DBConnection": "[parameters('sqlServer').databaseConnString]",
                        "sa:AlertJobConsumerGroupPrefix": "[parameters('B2CVariables').AlertJobConsumerGroupPrefix]",
                        "sa:AlertJobConsumerGroupCount": "19",
                        "sa:StreamingUnits": "1",
                        "eventHub:Name": "[parameters('eventHub').eventHubName]",
                        "eventHub:NameSpace": "[parameters('eventHub').namespaceName]",
                        "eventHub:PolicyName": "[parameters('eventHub').defaultSASKeyName]",
                        "eventHub:PolicyKey": "[listkeys(parameters('eventHub').eventhubNamepaceResourceID, '2017-04-01').primaryKey]",
                        "eventHub:ConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "b2c:AadInstance": "[parameters('B2CVariables').b2cAadInstance]",
                        "b2c:Tenant": "[parameters('B2CVariables').b2cTenant]",
                        "b2c:ClientId": "[parameters('B2CVariables').b2cClientId]",
                        "b2c:SignUpInPolicyId": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                        "b2c:MobileTokenUrl": "[parameters('B2CVariables').MobileTokenURL]",
                        "b2c:MobileInstanceUrl": "[parameters('B2CVariables').MobileInstanceUrl]",
                        "blobStorage:ConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageName,';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageName), '2015-06-15').key1,';EndpointSuffix=core.windows.net')]",
                        "b2c:MobileRedirectUrl": "[parameters('B2CVariables').b2cNativeRedirectURL]",
                        "documentDB:Endpoint": "[parameters('documentDBEndpoint')]", 
                        "documentDB:AuthKey": "[listKeys(parameters('documentDB').documentDBAuthKey, '2015-04-08').primaryMasterKey]",
                        "documentDB:OfferThroughput": "[parameters('documentDB').DocDBOfferThroughput]",
                        "documentDB:AccountId": "[parameters('documentDB').DocDBAccountName]",
                        "simulator:DbServer": "[parameters('sqlServer').sqlServerAddress]",
                        "simulator:DbName": "[parameters('sqlServer').sqldatabasename]",
                        "simulator:DbUserId": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "simulator:DbPassword": "[parameters('sqlServer').sqlAdministratorLoginPassword]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('webApp').webSiteName]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('webApp').location]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanName]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName))]": "empty",
                "displayName": "Website"
            },
            "properties": {
                "name": "[parameters('webApp').webSiteName]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName)]"
                    ],
                    "tags": {
                        "displayName": "WebAppConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015"
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('webApp').location]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/config/web')]"
                    ],
                    "tags": {
                        "displayName": "WebAppMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('webApp').WebAppPackageURI2]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "WebAppConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('webApp').BlobconnectionString]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('webApp').webSiteName)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "websiteAppSettings"
                    },
                    "properties": {
                        "restServer": "[concat('https://', parameters('trafficManagerSettings').trafficManagerName1,'.trafficmanager.net/')]",
                        "nodeserver": "[concat('https://', parameters('trafficManagerSettings').trafficManagerName2,'.trafficmanager.net/')]",
                        "b2cApplicationId": "[parameters('B2CVariables').b2cClientId]",
                        "tenantName": "[parameters('B2CVariables').b2cTenant]",
                        "signInPolicyName": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                        "redirect_uri": "[concat(parameters('webApp').websiteFullAddress1,'#/dashboard')]",
                        "EventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "EventHubPath": "[parameters('eventHub').eventHubName]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('nodeServer').nodeServerName]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('nodeServer').location]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanName]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName))]": "empty",
                "displayName": "NodeServer"
            },
            "properties": {
                "name": "[parameters('nodeServer').nodeServerName]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanName)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName)]"
                    ],
                    "tags": {
                        "displayName": "NodeServerConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015"
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('nodeServer').location]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/config/web')]"
                    ],
                    "tags": {
                        "displayName": "NodeServerMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('nodeServer').NodeServerPackageURI1]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "NodeServerConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('nodeServer').BlobconnectionString]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerName, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "nodeAppSettings"
                    },
                    "properties": {
                        "WEBSITE_NODE_DEFAULT_VERSION": "6.9.1",
                        "CUSTOMCONNSTRConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                        "CUSTOMCONNSTRConsumerGroup": "[concat(parameters('iotHub').d2cConsumerGroupName, '20')]",
                        "CUSTOMCONNSTREventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "CUSTOMCONNSTREventHubPath": "[parameters('eventHub').eventHubName]"
                    }
                }
            ]
        }
    ],
    "outputs": {
        "WebSiteUri": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('webApp').webSiteName)).hostnames[0]]"
        },
        "RESTSiteUri": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('restServer').apiServerName)).hostnames[0]]"
        }
    }
}
