{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "appInsights": {
            "type": "object"
        },
        "hostingPlan": {
            "type": "object"
        },
        "restServer": {
            "type": "object"
        },
        "webApp": {
            "type": "object"
        },
        "webJobStorage": {
            "type": "object"
        },
        "iotHub": {
            "type": "object"
        },
        "sqlServer": {
            "type": "object"
        },
        "eventHub": {
            "type": "object"
        },
        "B2CVariables": {
            "type": "object"
        },
        "documentDB": {
            "type": "object"
        },
        "nodeServer":{
            "type": "object"
        },
        "documentDBEndpoint":{
            "type": "string"
        },
        "trafficManagerSettings":{
            "type":"object"
        }
    },
    "variables": {},
    "resources": [
        {
            "name": "[parameters('webJobStorage').webjobStorageNameHr]",
            "type": "Microsoft.Storage/storageAccounts",
            "location": "[parameters('webJobStorage').locationHr]",
            "apiVersion": "2016-01-01",
            "sku": {
                "name": "[parameters('webJobStorage').webjobStorageTypeHr]"
            },
            "dependsOn": [],
            "tags": {
                "displayName": "webjobStorageHr"
            },
            "kind": "Storage"
        },
        {
            "apiVersion": "2014-04-01",
            "name": "[parameters('appInsights').appInsightResourceNameHr]",
            "type": "Microsoft.Insights/components",
            "location": "[parameters('appInsights').locationHr]",
            "dependsOn": [],
            "tags": {
                "displayName": "AppInsightsComponentHr"
            },
            "properties": {
                "ApplicationId": "[parameters('appInsights').appInsightResourceNameHr]"
            }
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('hostingPlan').hostingPlanNameHr]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[parameters('hostingPlan').locationHr]",
            "tags": {
                "displayName": "HostingPlanHr"
            },
            "sku": {
                "name": "[parameters('hostingPlan').webSkuNameHr]",
                "capacity": "[parameters('hostingPlan').skuCapacityHr]"
            },
            "properties": {
                "name": "[parameters('hostingPlan').hostingPlanNameHr]"
            }
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('restServer').apiServerNameHr]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('restServer').locationHr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameHr]",
                "[parameters('appInsights').appInsightResourceNameHr]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr))]": "empty",
                "displayName": "RESTServerHr"
            },
            "properties": {
                "name": "[parameters('restServer').apiServerNameHr]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr)]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConfigHr"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015",
                        "cors": {
                            "allowedOrigins": [
                                "[concat('https://', parameters('trafficManagerSettings').trafficManagerName, '.trafficmanager.net')]"
                            ]
                        }
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('restServer').locationHr]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr)]",
                        "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameHr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr,'/config/web')]"
                    ],
                    "tags": {
                        "displayName": "RESTServerMSDeployHr"
                    },
                    "properties": {
                        "packageUri": "[parameters('restServer').RESTServerPackageURI]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConnectionStringsHr"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('restServer').BlobconnectionString]",
                            "type": "Custom"
                        },
                        "DBConnection": {
                            "value": "[parameters('sqlServer').databaseConnString]",
                            "type": "Custom"
                        },
                        "AzureWebJobsDashboard": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameHr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageNameHr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]",
                            "type": "Custom"
                        },
                        "AzureWebJobsStorage": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameHr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageNameHr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr,'/config/connectionstrings')]"
                    ],
                    "tags": {
                        "displayName": "restAppSettingsHr"
                    },
                    "properties": {
                        "iotHub:ConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                        "iotHub:HostName": "[parameters('iotHub').iotHubHostName]",
                        "iotHub:SharedAccessPolicyKey": "[listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey]",
                        "iotHub:SharedAccessPolicyName": "[ parameters('iotHub').iotHubKeyName]",
                        "sql:Server": "[concat(parameters('sqlServer').sqlserverName,'.database.windows.net')]",
                        "sql:Database": "[parameters('sqlServer').sqldatabasename]",
                        "sql:User": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "sql:Password": "[parameters('sqlServer').sqlAdministratorLoginPassword]",
                        "sa:WindowsManagementUri": "[parameters('restServer').WindowsManagementUri]",
                        "sa:ReportJobName": "[parameters('restServer').ReportJobName]",
                        "sa:JobResourceGroup": "[parameters('restServer').JobResourceGroup]",
                        "sa:JobLocation": "[parameters('restServer').locationHr]",
                        "sa:AlertJobTable": "[parameters('restServer').alertJobTable]",
                        "ad:SubscriptionId": "[parameters('restServer').AdSubscriptionId]",
                        "ad:TenantId": "[parameters('restServer').AdTenantId]",
                        "ad:Endpoint": "[parameters('restServer').ADEndpoint]",
                        "ad:ClientId": "[parameters('restServer').AdClientId]",
                        "ad:ClientSecret": "[parameters('restServer').AdSecretKey]",
                        "DBConnection":"[parameters('sqlServer').databaseConnString]",
                        "sa:AlertJobConsumerGroupPrefix": "[parameters('B2CVariables').AlertJobConsumerGroupPrefix]",
                        "sa:AlertJobConsumerGroupCount": "19",
                        "sa:StreamingUnits": "3",
                        "eventHub:Name": "[parameters('eventHub').eventHubName]",
                        "eventHub:NameSpace": "[parameters('eventHub').namespaceName]",
                        "eventHub:PolicyName": "[parameters('eventHub').defaultSASKeyName]",
                        "eventHub:PolicyKey": "[listkeys(parameters('eventHub').eventhubNamepaceResourceID, '2017-04-01').primaryKey]",
                        "eventHub:ConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "b2c:AadInstance": "[parameters('B2CVariables').b2cAadInstance]",
                        "b2c:Tenant": "[parameters('B2CVariables').b2cTenant]",
                        "b2c:ClientId": "[parameters('B2CVariables').b2cClientIdHr]",
                        "b2c:SignUpInPolicyId": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                        "b2c:MobileTokenUrl": "[parameters('B2CVariables').MobileTokenURL]",
                        "b2c:MobileInstanceUrl": "[parameters('B2CVariables').MobileInstanceUrl]",
                        "blobStorage:ConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameHr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webjobStorage').webjobStorageNameHr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value,';EndpointSuffix=core.windows.net')]",
                        "b2c:MobileRedirectUrl": "[parameters('B2CVariables').b2cNativeRedirectURLHr]", 
                        "documentDB:Endpoint": "[parameters('documentDBEndpoint')]",
                        "documentDB:AuthKey": "[listKeys(parameters('documentDB').documentDBAuthKey, '2015-04-08').primaryMasterKey]",
                        "documentDB:OfferThroughput": "[parameters('documentDB').DocDBOfferThroughput]",
                        "documentDB:AccountId": "[parameters('documentDB').DocDBAccountName]",
                        "simulator:DbServer": "[parameters('sqlServer').sqlServerAddress]",
                        "simulator:DbName": "[parameters('sqlServer').sqldatabasename]",
                        "simulator:DbUserId": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "simulator:DbPassword": "[parameters('sqlServer').sqlAdministratorLoginPassword]",
                        "InstrumentationKey": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsights').appInsightResourceNameHr), '2014-04-01').InstrumentationKey]"
                    }
                }
            ]
        },      
          {
            "apiVersion": "2016-03-01",
            "name": "[parameters('nodeServer').nodeServerNameHr]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('nodeServer').locationHr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameHr]",
                "[parameters('appInsights').appInsightResourceNameHr]",
                "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr,'/config/appsettings')]"

            ],
            "tags": {
              "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr))]": "empty",
              "displayName": "NodeServerHr"
            },
            "properties": {
              "name": "[parameters('nodeServer').nodeServerNameHr]",
              "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr)]"
            },
            "resources": [
              {
                "apiVersion": "2015-08-01",
                "name": "web",
                "type": "config",
                "dependsOn": [
                  "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr)]"
                ],
                "tags": {
                  "displayName": "NodeServerConfigHr"
                },
                "properties": {
                  "phpVersion": "5.6",
                  "netFrameworkVersion": "v4.6",
                  "use32BitWorkerProcess": false,
                  "webSocketsEnabled": true,
                  "alwaysOn": true,
                  "remoteDebuggingEnabled": true,
                  "remoteDebuggingVersion": "VS2015"
                }
              },
              {
                "name": "MSDeploy",
                "type": "extensions",
                "location": "[parameters('nodeServer').locationHr]",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                    "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr)]",
                  "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr,'/config/web')]",
                  "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameHr)]"
                ],
                "tags": {
                  "displayName": "NodeServerMSDeployHr"
                },
                "properties": {
                  "packageUri": "[parameters('nodeServer').NodeServerPackageURI]"
                }
              },
              {
                "name": "connectionstrings",
                "type": "config",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                  "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr)]",
                  "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr, '/extensions/MSDeploy')]"
                ],
                "tags": {
                  "displayName": "NodeServerConnectionStringsHr"
                },
                "properties": {
                  "BlobConnection": {
                    "value": "[parameters('nodeServer').BlobconnectionString]",
                    "type": "Custom"
                  }
                }
              },
              {
                "name": "appsettings",
                "type": "config",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                    "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr)]",
                    "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr, '/extensions/MSDeploy')]",
                    "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr, '/config/connectionstrings')]"
                ],
                "tags": {
                    "displayName": "nodeAppSettings"
                },
                "properties": {
                    "WEBSITE_NODE_DEFAULT_VERSION":"6.9.1",
                    "CUSTOMCONNSTRConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                    "CUSTOMCONNSTRConsumerGroup": "[concat(parameters('iotHub').d2cConsumerGroupName, '1')]",
                    "CUSTOMCONNSTREventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                    "CUSTOMCONNSTREventHubPath": "[parameters('eventHub').eventHubName]",
                    "InstrumentationKey":  "[reference(resourceId('Microsoft.Insights/components', parameters('appInsights').appInsightResourceNameHr), '2014-04-01').InstrumentationKey]"
                }
            }
            ]
          },
          {
            "apiVersion": "2016-03-01",
            "name": "[parameters('webApp').webSiteNameHr]",
            "type": "Microsoft.Web/sites",
            "location":  "[parameters('webApp').locationHr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameHr]",
                "[parameters('appInsights').appInsightResourceNameHr]",
                "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameHr, '/config/appsettings')]"

            ],
            "tags": {
              "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr))]": "empty",
              "displayName": "WebsiteHr"
            },
            "properties": {
              "name": "[parameters('webApp').webSiteNameHr]",
              "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameHr)]"
            },
            "resources": [
              {
                "apiVersion": "2015-08-01",
                "name": "web",
                "type": "config",
                "dependsOn": [
                  "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr)]"
                ],
                "tags": {
                  "displayName": "WebAppConfigHr"
                },
                "properties": {
                  "phpVersion": "5.6",
                  "netFrameworkVersion": "v4.6",
                  "use32BitWorkerProcess": false,
                  "webSocketsEnabled": true,
                  "alwaysOn": true,
                  "remoteDebuggingEnabled": true,
                  "remoteDebuggingVersion": "VS2015"
                }
              },
              {
                "name": "MSDeploy",
                "type": "extensions",
                "location":"[parameters('webApp').locationHr]",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                    "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr)]",
                  "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr,'/config/web')]",
                  "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameHr)]"
                ],
                "tags": {
                  "displayName": "WebAppMSDeployHr"
                },
                "properties": {
                  "packageUri": "[parameters('webApp').WebAppPackageURI]"
                }
              },
              {
                "name": "connectionstrings",
                "type": "config",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                  "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr)]",
                  "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr, '/extensions/MSDeploy')]"
                ],
                "tags": {
                  "displayName": "WebAppConnectionStringsHr"
                },
                "properties": {
                  "BlobConnection": {
                    "value": "[parameters('webApp').BlobconnectionString]",
                    "type": "Custom"
                  }
                }
              },
              {
                "name": "appsettings",
                "type": "config",
                "apiVersion": "2015-08-01",
                "dependsOn": [
                    "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr)]",
                  "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr, '/config/connectionstrings')]"
                ],
                "tags": {
                  "displayName": "websiteAppSettingsHr"
                },
                "properties": {
                  "restServer": "[concat('https://', parameters('restServer').apiServerName,'.azurewebsites.net/')]",
                  "nodeserver": "[concat('https://', parameters('nodeServer').nodeServerNameHr,'.azurewebsites.net/')]",
                  "b2cApplicationId": "[parameters('B2CVariables').b2cClientIdHr]", 
                  "tenantName": "[parameters('B2CVariables').b2cTenant]",
                  "signInPolicyName": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                  "redirect_uri": "[concat(parameters('webApp').websiteFullAddressHr,'#/dashboard')]",
                  "EventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                  "EventHubPath": "[parameters('eventHub').eventHubName]",
                  "InstrumentationKey": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsights').appInsightResourceNameHr), '2014-04-01').InstrumentationKey]"
                }
              }
            ]
          }
    ],
    "outputs": {
        "WebSiteUriHr": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameHr)).hostnames[0]]"
        },
        "RESTSiteUriHr": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameHr)).hostnames[0]]"
        }
    }
}
