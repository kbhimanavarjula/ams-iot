{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "hostingPlan": {
            "type": "object"
        },
        "restServer": {
            "type": "object"
        },
        "webApp": {
            "type": "object"
        },
        "webJobStorage": {
            "type": "object"
        },
        "iotHub": {
            "type": "object"
        },
        "sqlServer": {
            "type": "object"
        },
        "eventHub": {
            "type": "object"
        },
        "B2CVariables": {
            "type": "object"
        },
        "documentDB": {
            "type": "object"
        },
        "nodeServer": {
            "type": "object"
        }
    },
    "variables": {},
    "resources": [
        {
            "name": "[parameters('webJobStorage').webjobStorageNameDr]",
            "type": "Microsoft.Storage/storageAccounts",
            "location": "[parameters('webJobStorage').locationDr]",
            "apiVersion": "2016-01-01",
            "sku": {
                "name": "[parameters('webJobStorage').webjobStorageType]"
            },
            "dependsOn": [],
            "tags": {
                "displayName": "webjobStorage"
            },
            "kind": "Storage"
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('hostingPlan').hostingPlanNameDr]",
            "type": "Microsoft.Web/serverfarms",
            "location": "[parameters('hostingPlan').locationDr]",
            "tags": {
                "displayName": "HostingPlan"
            },
            "sku": {
                "name": "[parameters('hostingPlan').webSkuName]",
                "capacity": "[parameters('hostingPlan').skuCapacity]"
            },
            "properties": {
                "name": "[parameters('hostingPlan').hostingPlanNameDr]"
            }
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('restServer').apiServerNameDr]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('restServer').locationDr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameDr]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr))]": "empty",
                "displayName": "RESTServer"
            },
            "properties": {
                "name": "[parameters('restServer').apiServerNameDr]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr)]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015",
                        "cors": {
                            "allowedOrigins": [
                                "[concat('https://', parameters('webApp').webSiteName, '.trafficmanager.net')]"
                            ]
                        }
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('restServer').locationDr]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameDr)]"
                    ],
                    "tags": {
                        "displayName": "RESTServerMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('restServer').RESTServerPackageURI1]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "RESTServerConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('restServer').BlobconnectionString]",
                            "type": "Custom"
                        },
                        "DBConnection": {
                            "value": "[parameters('sqlServer').databaseConnString]",
                            "type": "Custom"
                        },
                        "AzureWebJobsDashboard": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameDr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageNameDr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]",
                            "type": "Custom"
                        },
                        "AzureWebJobsStorage": {
                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameDr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webJobStorage').webjobStorageNameDr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value)]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "restAppSettings"
                    },
                    "properties": {
                        "iotHub:ConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                        "iotHub:HostName": "[parameters('iotHub').iotHubHostName]",
                        "iotHub:SharedAccessPolicyKey": "[listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey]",
                        "iotHub:SharedAccessPolicyName": "[ parameters('iotHub').iotHubKeyName]",
                        "sql:Server": "[concat(parameters('sqlServer').sqlFailoverGroupName,'.database.windows.net')]",
                        "sql:Database": "[parameters('sqlServer').sqldatabasename]",
                        "sql:User": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "sql:Password": "[parameters('sqlServer').sqlAdministratorLoginPassword]",
                        "sa:WindowsManagementUri": "[parameters('restServer').WindowsManagementUri]",
                        "sa:ReportJobName": "[parameters('restServer').ReportJobName]",
                        "sa:JobResourceGroup": "[parameters('restServer').JobResourceGroup]",
                        "sa:Joblocation": "[parameters('restServer').locationDr]",
                        "sa:AlertJobTable": "[parameters('restServer').alertJobTable]",
                        "ad:SubscriptionId": "[parameters('restServer').AdSubscriptionId]",
                        "ad:TenantId": "[parameters('restServer').AdTenantId]",
                        "ad:Endpoint": "[parameters('restServer').ADEndpoint]",
                        "ad:ClientId": "[parameters('restServer').AdClientId]",
                        "ad:ClientSecret": "[parameters('restServer').AdSecretKey]",
                        "DBConnection": "[parameters('sqlServer').databaseConnString]",
                        "sa:AlertJobConsumerGroupPrefix": "[parameters('B2CVariables').AlertJobConsumerGroupPrefix]",
                        "sa:AlertJobConsumerGroupCount": "19",
                        "sa:StreamingUnits": "3",
                        "eventHub:Name": "[parameters('eventHub').eventHubName]",
                        "eventHub:NameSpace": "[parameters('eventHub').namespaceName]",
                        "eventHub:PolicyName": "[parameters('eventHub').defaultSASKeyName]",
                        "eventHub:PolicyKey": "[listkeys(parameters('eventHub').eventhubNamepaceResourceID, '2017-04-01').primaryKey]",
                        "eventHub:ConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "b2c:AadInstance": "[parameters('B2CVariables').b2cAadInstance]",
                        "b2c:Tenant": "[parameters('B2CVariables').b2cTenant]",
                        "b2c:ClientId": "[parameters('B2CVariables').b2cClientIdDr]",
                        "b2c:SignUpInPolicyId": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                        "b2c:MobileTokenUrl": "[parameters('B2CVariables').MobileTokenURL]",
                        "b2c:MobileInstanceUrl": "[parameters('B2CVariables').MobileInstanceUrl]",
                        "blobStorage:ConnectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=',parameters('webJobStorage').webjobStorageNameDr,';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('webjobStorage').webjobStorageNameDr), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value,';EndpointSuffix=core.windows.net')]",
                        "b2c:MobileRedirectUrl": "[parameters('B2CVariables').b2cNativeRedirectURLDr]",
                        "documentDB:Endpoint": "[reference(resourceId('Microsoft.DocumentDb/databaseAccounts/', parameters('documentDB').DocDBAccountName)).documentEndpoint]",
                        "documentDB:AuthKey": "[listKeys(parameters('documentDB').documentDBAuthKey, '2015-04-08').primaryMasterKey]",
                        "documentDB:OfferThroughput": "[parameters('documentDB').DocDBOfferThroughput]",
                        "documentDB:AccountId": "[parameters('documentDB').DocDBAccountName]",
                        "simulator:DbServer": "[parameters('sqlServer').sqlServerAddress]",
                        "simulator:DbName": "[parameters('sqlServer').sqldatabasename]",
                        "simulator:DbUserId": "[parameters('sqlServer').sqlAdministratorLogin]",
                        "simulator:DbPassword": "[parameters('sqlServer').sqlAdministratorLoginPassword]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('webApp').webSiteNameDr]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('webApp').locationDr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameDr]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr))]": "empty",
                "displayName": "Website"
            },
            "properties": {
                "name": "[parameters('webApp').webSiteNameDr]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr)]"
                    ],
                    "tags": {
                        "displayName": "WebAppConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015"
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('webApp').locationDr]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/config/web')]",
                        "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameDr)]"
                    ],
                    "tags": {
                        "displayName": "WebAppMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('webApp').WebAppPackageURI1]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "WebAppConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('webApp').BlobconnectionString]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', parameters('webApp').webSiteNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "websiteAppSettings"
                    },
                    "properties": {
                        "restServer": "[concat('https://', parameters('restServer').apiServerName,'.azurewebsites.net/')]",
                        "nodeserver": "[concat('https://', parameters('nodeServer').nodeServerName,'.azurewebsites.net/')]",
                        "b2cApplicationId": "[parameters('B2CVariables').b2cClientIdDr]",
                        "tenantName": "[parameters('B2CVariables').b2cTenant]",
                        "signInPolicyName": "[parameters('B2CVariables').b2cSignUpSignInPolicyId]",
                        "redirect_uri": "[concat(parameters('webApp').websiteFullAddress1,'#/dashboard')]",
                        "EventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "EventHubPath": "[parameters('eventHub').eventHubName]"
                    }
                }
            ]
        },
        {
            "apiVersion": "2016-03-01",
            "name": "[parameters('nodeServer').nodeServerNameDr]",
            "type": "Microsoft.Web/sites",
            "location": "[parameters('nodeServer').locationDr]",
            "dependsOn": [
                "[parameters('hostingPlan').hostingPlanNameDr]"
            ],
            "tags": {
                "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr))]": "empty",
                "displayName": "NodeServer"
            },
            "properties": {
                "name": "[parameters('nodeServer').nodeServerNameDr]",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('hostingPlan').hostingPlanNameDr)]"
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "name": "web",
                    "type": "config",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr)]"
                    ],
                    "tags": {
                        "displayName": "NodeServerConfig"
                    },
                    "properties": {
                        "phpVersion": "5.6",
                        "netFrameworkVersion": "v4.6",
                        "use32BitWorkerProcess": false,
                        "webSocketsEnabled": true,
                        "alwaysOn": true,
                        "remoteDebuggingEnabled": true,
                        "remoteDebuggingVersion": "VS2015"
                    }
                },
                {
                    "name": "MSDeploy",
                    "type": "extensions",
                    "location": "[parameters('nodeServer').locationDr]",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Storage/storageAccounts/', parameters('webJobStorage').webjobStorageNameDr)]"
                    ],
                    "tags": {
                        "displayName": "NodeServerMSDeploy"
                    },
                    "properties": {
                        "packageUri": "[parameters('nodeServer').NodeServerPackageURI1]"
                    }
                },
                {
                    "name": "connectionstrings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "NodeServerConnectionStrings"
                    },
                    "properties": {
                        "BlobConnection": {
                            "value": "[parameters('nodeServer').BlobconnectionString]",
                            "type": "Custom"
                        }
                    }
                },
                {
                    "name": "appsettings",
                    "type": "config",
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr)]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/config/web')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/config/connectionstrings')]",
                        "[concat('Microsoft.Web/sites/', parameters('nodeServer').nodeServerNameDr, '/extensions/MSDeploy')]"
                    ],
                    "tags": {
                        "displayName": "nodeAppSettings"
                    },
                    "properties": {
                        "WEBSITE_NODE_DEFAULT_VERSION": "6.9.1",
                        "CUSTOMCONNSTRConnectionString": "[concat('HostName=',parameters('iotHub').iotHubName,'.azure-devices.net;SharedAccessKeyName=',parameters('iotHub').iotHubKeyName,';SharedAccessKey=',listKeys(parameters('iotHub').iotHubID, '2016-02-03').primaryKey)]",
                        "CUSTOMCONNSTRConsumerGroup": "[concat(parameters('iotHub').d2cConsumerGroupName, '1')]",
                        "CUSTOMCONNSTREventHubConnectionString": "[parameters('eventHub').eventhubConnectionString]",
                        "CUSTOMCONNSTREventHubPath": "[parameters('eventHub').eventHubName]"
                    }
                }
            ]
        }
    ],
    "outputs": {
        "WebSiteUri": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('webApp').webSiteNameDr)).hostnames[0]]"
        },
        "RESTSiteUri": {
            "type": "string",
            "value": "[reference(concat('Microsoft.Web/sites/', parameters('restServer').apiServerNameDr)).hostnames[0]]"
        }
    }
}
